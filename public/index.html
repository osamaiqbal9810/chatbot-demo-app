<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>WhatsApp Bot Demo</title>
  <style>
    body { font-family: Arial; margin:0; background:#f4f6f9; }
    header { background:#25D366; color:#fff; padding:12px; text-align:center; font-size:20px; font-weight:bold; }
    #loginScreen, #app { padding:20px; text-align:center; }
    #loginScreen input, #app input { display:block; margin:10px auto; padding:10px; width:250px; }
    #loginScreen button, #app button { background:#25D366; color:white; border:none; padding:10px 20px; cursor:pointer; border-radius:4px; margin-top:10px; }

    /* Tabs */
    .tabs { display:flex; justify-content:center; margin-bottom:10px; }
    .tab { padding:10px 20px; cursor:pointer; border-bottom:2px solid transparent; }
    .tab.active { border-bottom:2px solid #25D366; font-weight:bold; }

    .tab-content { display:none; }
    .tab-content.active { display:block; }

    .messages { display:flex; flex-direction:column; height:300px; overflow-y:auto; background:white; padding:10px; border-radius:8px; box-shadow:0 0 4px rgba(0,0,0,0.1); margin-bottom:10px; }
    .msg { margin:6px; padding:10px; border-radius:8px; max-width:60%; word-wrap:break-word; }
    .user { background:#DCF8C6; align-self:flex-end; text-align:right; }
    .bot { background:#fff; border:1px solid #ddd; align-self:flex-start; text-align:left; }

    .msg-input { display:flex; justify-content:center; margin-top:10px; }
    .msg-input input { flex:1; padding:10px; border:1px solid #ccc; border-radius:4px 0 0 4px; }
    .msg-input button { padding:10px 16px; border-radius:0 4px 4px 0; margin-left:5px; }

    /* Templates list */
    .template-item { display:flex; justify-content:space-between; background:white; padding:10px; margin:6px 0; border-radius:6px; box-shadow:0 0 2px rgba(0,0,0,0.1); }
  </style>
</head>
<body>
  <header>WhatsApp Bot Demo</header>

  <!-- Login Screen -->
  <div id="loginScreen">
    <h2>Login</h2>
    <input id="email" type="email" placeholder="Email" />
    <input id="password" type="password" placeholder="Password" />
    <button onclick="login()">Login</button>
  </div>

  <!-- App -->
  <div id="app" style="display:none;">
    <!-- Tabs -->
    <div class="tabs">
      <div class="tab active" onclick="showTab('chatTab')">Chat</div>
      <div class="tab" onclick="showTab('templateTab')">Templates</div>
    </div>

    <!-- Chat Tab -->
    <div id="chatTab" class="tab-content active">
      <div class="messages" id="messages"></div>
      <div class="msg-input">
        <input id="msgInput" type="text" placeholder="Type a message..." />
        <button onclick="sendMsg()">Send</button>
        <button onclick="prefillTemplate()">Send Template</button>
      </div>
    </div>

    <!-- Template Tab -->
    <div id="templateTab" class="tab-content">
      <h3>Your Templates</h3>
      <div id="templateList">Loading templates...</div>
      <button onclick="fetchTemplates()">Refresh Templates</button>
    </div>
  </div>

  <script>
    const WHATSAPP_API_URL = 'https://graph.facebook.com/v22.0/766109259924666/messages';
    const WHATSAPP_ACCESS_TOKEN = 'EAASeUmOZCcKwBPWZCwvgdZBf77BZBhwcnSuXZAiNSUNZA2XALgPr3Iy7kiZArR3b2oYZBUQX2ozkz4EEzOanRpYq1RFGBqaFnUFCM7auhOZBkkbp9eOnpKFWn3Ec5JgwSZBZAqLZB50iZBwCnysqP1iZBDnKn9rZCFrXLGbU533HhhZByWvB2HjXv8koqUNI9h272crW7eIBnyKe3N7GRbV0C9g6C4niM835VB7yhhgZBJg0XCpYA4njNXnve2FlU43pJ2tPscgZDZD';
    const RECIPIENT_PHONE = '923319700834'; // user number

    function login() {
      const email = document.getElementById("email").value.trim();
      const password = document.getElementById("password").value.trim();
      if (!email || !password) return alert("Enter email and password!");
      
      const allow = confirm("This app requests permission to:\n- Access user data\n- Send messages via WhatsApp API\n- Manage profile\n- Access analytics");
      if (!allow) return alert("Permission denied.");

      document.getElementById("loginScreen").style.display = "none";
      document.getElementById("app").style.display = "block";

      fetchTemplates();
    }

    function showTab(tabId) {
      document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
      document.getElementById(tabId).classList.add('active');
      document.querySelectorAll('.tab').forEach(el => el.classList.remove('active'));
      event.target.classList.add('active');
    }

    function addMessage(text, type) {
      const div = document.createElement("div");
      div.className = "msg " + type;
      div.innerText = text;
      document.getElementById("messages").appendChild(div);
      div.scrollIntoView({ behavior: "smooth" });
    }

    function prefillTemplate() {
      document.getElementById("msgInput").value = "Hi, Welcome to Eyratech-Bot";
    }

    async function sendWhatsApp(payload) {
      try {
        const response = await fetch(WHATSAPP_API_URL, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${WHATSAPP_ACCESS_TOKEN}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(payload)
        });
        const data = await response.json();
        if (response.ok) addMessage("✅ WhatsApp message sent", "bot");
        else addMessage("❌ Failed: " + (data.error?.message || 'Unknown'), "bot");
        console.log("API response:", data);
      } catch (err) {
        addMessage("❌ Error: " + err.message, "bot");
        console.error(err);
      }
    }

    async function sendMsg() {
      const messageText = document.getElementById("msgInput").value.trim();
      if (!messageText) return alert("Type a message or use template!");
      addMessage(messageText, "user");

      let payload;
      if (messageText === "Hi, Welcome to Eyratech-Bot") {
        payload = {
          messaging_product: "whatsapp",
          recipient_type: "individual",
          to: RECIPIENT_PHONE,
          type: "template",
          template: { name: "hello_world", language: { code: "en_US" } }
        };
      } else {
        payload = {
          messaging_product: "whatsapp",
          recipient_type: "individual",
          to: RECIPIENT_PHONE,
          type: "text",
          text: { preview_url: false, body: messageText }
        };
      }

      await sendWhatsApp(payload);
      document.getElementById("msgInput").value = "";
    }

    async function fetchTemplates() {
      const WABA_ID = '2111733529352640';
    const url = `https://graph.facebook.com/v22.0/${WABA_ID}/message_templates`
      try {
        const res = await fetch(url, {
          headers: { 'Authorization': `Bearer ${WHATSAPP_ACCESS_TOKEN}` }
        });
        const data = await res.json();
        const list = document.getElementById("templateList");
        list.innerHTML = '';

        if (!data.data || data.data.length === 0) {
          list.innerText = "No templates found.";
          return;
        }

        data.data.forEach(tpl => {
          const div = document.createElement("div");
          div.className = "template-item";
          div.innerHTML = `<span>${tpl.name}</span><button onclick='sendTemplate("${tpl.name}")'>Send</button>`;
          list.appendChild(div);
        });

      } catch (err) {
        console.error(err);
        document.getElementById("templateList").innerText = "Error fetching templates.";
      }
    }

    async function sendTemplate(name) {
      addMessage(`Sending template: ${name}`, "user");
      const payload = {
        messaging_product: "whatsapp",
        recipient_type: "individual",
        to: RECIPIENT_PHONE,
        type: "template",
        template: { name, language: { code: "en_US" } }
      };
      await sendWhatsApp(payload);
    }
  </script>
</body>
</html>
